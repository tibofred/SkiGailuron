server {
  listen ${PORT:-8080};
  server_name _;

  root /app/web;
  index app.php;

  # Optional: redirect "/" to your default locale
  location = / { return 301 /fr/; }

  # Route everything that isnâ€™t a real file/dir to app.php
  location / {
    try_files $uri /app.php$is_args$args;
  }

  # Serve static files
  location ~* \.(?:css|js|png|jpe?g|gif|svg|ico|webp|woff2?|ttf|eot)$ {
    try_files $uri =404;
    access_log off;
    expires 30d;
    add_header Cache-Control "public";
  }

  # Deny hidden/sensitive
  location ~ /\.               { deny all; }
  location ~* ^/\.ht          { deny all; }
  location ~* /(composer\.(json|lock)|package-lock\.json|symfony\.lock)$ { deny all; }
  location ~* ^/\.env         { deny all; }

  # Only pass the front controller to PHP-FPM
  location ~ ^/app\.php(/|$) {
    include        /etc/nginx/fastcgi_params;
    fastcgi_pass   127.0.0.1:9000;         # or unix:/run/php/php-fpm.sock
    fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param  QUERY_STRING    $query_string;

    # Make HTTPS visible to Symfony (behind Kinsta proxy)
    map $http_x_forwarded_proto $fastcgi_https { default off; https on; }
    fastcgi_param  HTTPS $fastcgi_https;

    fastcgi_read_timeout 300;
    fastcgi_buffer_size 32k;
    fastcgi_buffers 8 32k;
  }

  # Block executing any other PHP files
  location ~ \.php$ { return 404; }
}
